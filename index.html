<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>v8.go by idada</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>v8.go</h1>
        <p>V8 JavaScript engine bindings for Go</p>

        <p class="view"><a href="https://github.com/idada/v8.go">View the Project on GitHub <small>idada/v8.go</small></a></p>


        <ul>
          <li><a href="https://github.com/idada/v8.go/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/idada/v8.go/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/idada/v8.go">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="v8go" class="anchor" href="#v8go"><span class="octicon octicon-link"></span></a>v8.go</h1>

<p>V8 JavaScript engine bindings for Go.</p>

<h1>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h1>

<ul>
<li>Thread safe</li>
<li>Thorough and careful testing</li>
<li>Boolean, Number, String, Object, Array, Regexp, Function</li>
<li>Compile and run JavaScript</li>
<li>Save and load pre-compiled script data</li>
<li>Create JavaScript context with global object template</li>
<li>Operate JavaScript object properties and array elements in Go</li>
<li>Define JavaScript object template in Go with property accessors and interceptors</li>
<li>Define JavaScript function template in Go</li>
<li>Catch JavaScript exception in Go</li>
<li>Throw JavaScript exception by Go</li>
<li>JSON parse and generate</li>
<li>Powerful binding API</li>
</ul><h1>
<a name="install" class="anchor" href="#install"><span class="octicon octicon-link"></span></a>Install</h1>

<p>For 'curl' user. please run this shell command:</p>

<blockquote>
<p>curl -O <a href="https://raw.github.com/idada/v8.go/master/get.sh">https://raw.github.com/idada/v8.go/master/get.sh</a> &amp;&amp; chmod +x get.sh &amp;&amp; ./get.sh v8.go</p>
</blockquote>

<p>For 'wget' user. Please run this shell command:</p>

<blockquote>
<p>wget <a href="https://raw.github.com/idada/v8.go/master/get.sh">https://raw.github.com/idada/v8.go/master/get.sh</a> &amp;&amp; chmod +x get.sh &amp;&amp; ./get.sh v8.go</p>
</blockquote>

<p>Note: require Go version 1.2 and Git.</p>

<h1>
<a name="hello-world" class="anchor" href="#hello-world"><span class="octicon octicon-link"></span></a>Hello World</h1>

<p>This 'Hello World' program shows how to use v8.go to compile and run JavaScript code then get the result.</p>

<div class="highlight highlight-go"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">"github.com/idada/v8.go"</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">engine</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>
    <span class="nx">script</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span>
        <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">"'Hello ' + 'World!'"</span><span class="p">),</span> 
        <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nx">context</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewContext</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">:=</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span>
        <span class="nb">println</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">ToString</span><span class="p">())</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>

<h1>
<a name="fast-binding" class="anchor" href="#fast-binding"><span class="octicon octicon-link"></span></a>Fast Binding</h1>

<div class="highlight highlight-go"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">"fmt"</span>
<span class="kn">import</span> <span class="s">"reflect"</span>
<span class="kn">import</span> <span class="s">"github.com/idada/v8.go"</span>

<span class="kd">type</span> <span class="nx">MyType</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Id</span>       <span class="kt">int</span>
    <span class="nx">Name</span>     <span class="kt">string</span>
    <span class="nx">Data</span>     <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
    <span class="nx">Callback</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">MyType</span><span class="p">)</span> <span class="nx">Dump</span><span class="p">(</span><span class="nx">info</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span>
        <span class="s">"Info: \"%s\", Id: %d, Name: \"%s\", Data: %v\n"</span><span class="p">,</span>
        <span class="nx">info</span><span class="p">,</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">engine</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>

    <span class="nx">global</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewObjectTemplate</span><span class="p">()</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">Bind</span><span class="p">(</span><span class="s">"MyType"</span><span class="p">,</span> <span class="nx">MyType</span><span class="p">{})</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">Bind</span><span class="p">(</span><span class="s">"print"</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="o">...</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">Bind</span><span class="p">(</span><span class="s">"test"</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="o">*</span><span class="nx">v8</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">raw</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">GetInternalField</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="o">*</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
        <span class="nx">raw</span><span class="p">.</span><span class="nx">Interface</span><span class="p">().(</span><span class="o">*</span><span class="nx">MyType</span><span class="p">).</span><span class="nx">Callback</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="s">"dada"</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">engine</span><span class="p">.</span><span class="nx">NewContext</span><span class="p">(</span><span class="nx">global</span><span class="p">).</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cs</span><span class="p">.</span><span class="nx">Eval</span><span class="p">(</span><span class="s">`</span>
<span class="s">            var a = new MyType();</span>

<span class="s">            a.Dump("old");</span>

<span class="s">            a.Id = 10;</span>
<span class="s">            a.Name = "Hello";</span>
<span class="s">            a.Data = {</span>
<span class="s">                'x': 1,</span>
<span class="s">                'y': 2</span>
<span class="s">            };</span>
<span class="s">            a.Dump("new");</span>

<span class="s">            a.Callback = function(a, b) {</span>
<span class="s">                print(a, b);</span>
<span class="s">            }</span>

<span class="s">            a.Callback(10, "Hello");</span>

<span class="s">            test(a);</span>
<span class="s">        `</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>

</pre></div>

<h1>
<a name="performance-and-stability-" class="anchor" href="#performance-and-stability-"><span class="octicon octicon-link"></span></a>Performance and Stability </h1>

<p>The benchmark result on my iMac:</p>

<pre><code>NewContext     249474 ns/op
NewInteger        984 ns/op
NewString         983 ns/op
NewObject        1036 ns/op
NewArray0        1130 ns/op
NewArray5        1314 ns/op
NewArray20       1666 ns/op
NewArray100      3124 ns/op
Compile         11059 ns/op
PreCompile      11697 ns/op
RunScript        1085 ns/op
JsFunction       1114 ns/op
GoFunction       1630 ns/op
Getter           2060 ns/op
Setter           2934 ns/op
TryCatch        43097 ns/op
</code></pre>

<p>I write many test and benchmark to make sure v8.go stable and efficient.</p>

<p>There is a shell script named 'test.sh' in the project. </p>

<p>It can auto configure cgo environment variables and run test.</p>

<p>For example:</p>

<pre><code>./test.sh . .
</code></pre>

<p>The above command will run all of test and benchmark.</p>

<p>The first argument of test.sh is test name pattern, second argument is benchmark name pattern.</p>

<p>For example:</p>

<pre><code>./test.sh ThreadSafe Array
</code></pre>

<p>The above command will run all of thread safe test and all of benchmark about Array type.</p>

<h1>
<a name="concepts" class="anchor" href="#concepts"><span class="octicon octicon-link"></span></a>Concepts</h1>

<h2>
<a name="engine" class="anchor" href="#engine"><span class="octicon octicon-link"></span></a>Engine</h2>

<p>In v8.go, engine type is the wrapper of v8::Isolate.</p>

<p>Because V8 engine use thread-local storage but cgo calls may be execute in different thread. So v8.go use v8::Locker to make sure V8 engine's thread-local data initialized. And the locker make v8.go thread safe.</p>

<p>You can create different engine instance for data isolate or improve efficiency of concurrent purpose.</p>

<div class="highlight highlight-go"><pre><span class="nx">engine1</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>
<span class="nx">engine2</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>
</pre></div>

<h2>
<a name="script" class="anchor" href="#script"><span class="octicon octicon-link"></span></a>Script</h2>

<p>When you want to run some JavaScript. You need to compile first.</p>

<p>Scripts can run many times or run in different context.</p>

<div class="highlight highlight-go"><pre><span class="nx">script</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`"Hello " + "World!"`</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</pre></div>

<p>The Engine.Compile() method take 3 arguments. </p>

<p>The first is the code.</p>

<p>The second is a ScriptOrigin, it stores script's file name or line number offset etc. You can use ScriptOrigin to make error message and stack trace friendly.</p>

<div class="highlight highlight-go"><pre><span class="nx">name</span> <span class="o">:=</span> <span class="s">"my_file.js"</span>
<span class="nx">real</span> <span class="o">:=</span> <span class="nx">ReadFile</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="nx">code</span> <span class="o">:=</span> <span class="s">"function(_export){\n"</span> <span class="o">+</span> <span class="nx">real</span> <span class="o">+</span> <span class="s">"\n}"</span>
<span class="nx">origin</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewScriptOrigin</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">script</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</pre></div>

<p>The third is a ScriptData, it's pre-parsing data, as obtained by Engine.PreCompile(). If you want to compile a script many time, you can use ScriptData to speeds compilation. </p>

<div class="highlight highlight-go"><pre><span class="nx">code</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`"Hello " + "World!"`</span><span class="p">)</span>
<span class="nx">data</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">PreCompile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">script1</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
<span class="nx">script2</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</pre></div>

<h2>
<a name="context" class="anchor" href="#context"><span class="octicon octicon-link"></span></a>Context</h2>

<p>The description in V8 embedding guide:</p>

<blockquote>
<p>In V8, a context is an execution environment that allows separate, unrelated, JavaScript applications to run in a single instance of V8. You must explicitly specify the context in which you want any JavaScript code to be run.</p>
</blockquote>

<p>In v8.go, you can create many contexts from a V8 engine instance. When you want to run some JavaScript in a context. You need to enter the context by calling Scope() and run the JavaScript in the callback.</p>

<div class="highlight highlight-go"><pre><span class="nx">context</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">){</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
<span class="p">})</span>
</pre></div>

<p>Context in V8 is necessary. So in v8.go you can do this:</p>

<div class="highlight highlight-go"><pre><span class="nx">context</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context2</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewContext</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
    <span class="nx">context2</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs2</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">})</span>
<span class="p">})</span>
</pre></div>

<h2>
<a name="more" class="anchor" href="#more"><span class="octicon octicon-link"></span></a>More</h2>

<p>Please read <code>v8_all_test.go</code> and the codes in <code>samples</code> folder.</p>

<h1>
<a name="%E4%B8%AD%E6%96%87%E4%BB%8B%E7%BB%8D" class="anchor" href="#%E4%B8%AD%E6%96%87%E4%BB%8B%E7%BB%8D"><span class="octicon octicon-link"></span></a>中文介绍</h1>

<p>V8引擎的Go语言绑定。</p>

<h1>
<a name="%E7%89%B9%E6%80%A7" class="anchor" href="#%E7%89%B9%E6%80%A7"><span class="octicon octicon-link"></span></a>特性</h1>

<ul>
<li>线程安全</li>
<li>详细的测试</li>
<li>数据类型：Boolean, Number, String, Object, Array, Regexp, Function</li>
<li>编译并运行JavaScript</li>
<li>保存和加载预编译的JavaScript数据</li>
<li>创建带有全局对象模板的Context</li>
<li>在Go语言端操作和访问JavaScript数组的元素</li>
<li>在Go语言端操作和访问JavaScript对象的属性</li>
<li>用Go语言创建支持属性访问器和拦截器的JavaScript对象模板</li>
<li>用Go语言创建JavaScript函数模板</li>
<li>在Go语言端捕获JavaScript的异常</li>
<li>从Go语言端抛出JavaScript的异常</li>
<li>JSON解析和生成</li>
<li>强大的绑定功能</li>
</ul><h1>
<a name="%E5%AE%89%E8%A3%85" class="anchor" href="#%E5%AE%89%E8%A3%85"><span class="octicon octicon-link"></span></a>安装</h1>

<p>'curl'用户请运行以下脚本：</p>

<blockquote>
<p>curl -O <a href="https://raw.github.com/idada/v8.go/master/get.sh">https://raw.github.com/idada/v8.go/master/get.sh</a> &amp;&amp; chmod +x get.sh &amp;&amp; ./get.sh v8.go</p>
</blockquote>

<p>'wget'用户请运行以下脚本：</p>

<blockquote>
<p>wget <a href="https://raw.github.com/idada/v8.go/master/get.sh">https://raw.github.com/idada/v8.go/master/get.sh</a> &amp;&amp; chmod +x get.sh &amp;&amp; ./get.sh v8.go</p>
</blockquote>

<p>需求本地安装有Go 1.2和git命令。</p>

<h1>
<a name="hello-world-1" class="anchor" href="#hello-world-1"><span class="octicon octicon-link"></span></a>Hello World</h1>

<p>以下是一段Hello World程序，用来展示v8.go如何编译和运行JavaScript并获得结果：</p>

<div class="highlight highlight-go"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">"github.com/idada/v8.go"</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">engine</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>
    <span class="nx">script</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span>
        <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">"'Hello ' + 'World!'"</span><span class="p">),</span> 
        <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nx">context</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewContext</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">:=</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span>
        <span class="nb">println</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">ToString</span><span class="p">())</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>

<h1>
<a name="%E5%BF%AB%E9%80%9F%E7%BB%91%E5%AE%9A" class="anchor" href="#%E5%BF%AB%E9%80%9F%E7%BB%91%E5%AE%9A"><span class="octicon octicon-link"></span></a>快速绑定</h1>

<div class="highlight highlight-go"><pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">"fmt"</span>
<span class="kn">import</span> <span class="s">"reflect"</span>
<span class="kn">import</span> <span class="s">"github.com/idada/v8.go"</span>

<span class="kd">type</span> <span class="nx">MyType</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Id</span>       <span class="kt">int</span>
    <span class="nx">Name</span>     <span class="kt">string</span>
    <span class="nx">Data</span>     <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
    <span class="nx">Callback</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">MyType</span><span class="p">)</span> <span class="nx">Dump</span><span class="p">(</span><span class="nx">info</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span>
        <span class="s">"Info: \"%s\", Id: %d, Name: \"%s\", Data: %v\n"</span><span class="p">,</span>
        <span class="nx">info</span><span class="p">,</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">engine</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>

    <span class="nx">global</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewObjectTemplate</span><span class="p">()</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">Bind</span><span class="p">(</span><span class="s">"MyType"</span><span class="p">,</span> <span class="nx">MyType</span><span class="p">{})</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">Bind</span><span class="p">(</span><span class="s">"print"</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">v</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="o">...</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">global</span><span class="p">.</span><span class="nx">Bind</span><span class="p">(</span><span class="s">"test"</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="o">*</span><span class="nx">v8</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">raw</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">GetInternalField</span><span class="p">(</span><span class="mi">0</span><span class="p">).(</span><span class="o">*</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
        <span class="nx">raw</span><span class="p">.</span><span class="nx">Interface</span><span class="p">().(</span><span class="o">*</span><span class="nx">MyType</span><span class="p">).</span><span class="nx">Callback</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="s">"dada"</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">engine</span><span class="p">.</span><span class="nx">NewContext</span><span class="p">(</span><span class="nx">global</span><span class="p">).</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cs</span><span class="p">.</span><span class="nx">Eval</span><span class="p">(</span><span class="s">`</span>
<span class="s">            var a = new MyType();</span>

<span class="s">            a.Dump("old");</span>

<span class="s">            a.Id = 10;</span>
<span class="s">            a.Name = "Hello";</span>
<span class="s">            a.Data = {</span>
<span class="s">                'x': 1,</span>
<span class="s">                'y': 2</span>
<span class="s">            };</span>
<span class="s">            a.Dump("new");</span>

<span class="s">            a.Callback = function(a, b) {</span>
<span class="s">                print(a, b);</span>
<span class="s">            }</span>

<span class="s">            a.Callback(10, "Hello");</span>

<span class="s">            test(a);</span>
<span class="s">        `</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>

</pre></div>

<h1>
<a name="%E6%80%A7%E8%83%BD%E5%92%8C%E7%A8%B3%E5%AE%9A%E6%80%A7-" class="anchor" href="#%E6%80%A7%E8%83%BD%E5%92%8C%E7%A8%B3%E5%AE%9A%E6%80%A7-"><span class="octicon octicon-link"></span></a>性能和稳定性 </h1>

<p>以下是在我的iMac上运行benchmark的输出结果:</p>

<pre><code>NewContext     249474 ns/op
NewInteger        984 ns/op
NewString         983 ns/op
NewObject        1036 ns/op
NewArray0        1130 ns/op
NewArray5        1314 ns/op
NewArray20       1666 ns/op
NewArray100      3124 ns/op
Compile         11059 ns/op
PreCompile      11697 ns/op
RunScript        1085 ns/op
JsFunction       1114 ns/op
GoFunction       1630 ns/op
Getter           2060 ns/op
Setter           2934 ns/op
TryCatch        43097 ns/op
</code></pre>

<p>我写了很多的单元测试和基准测试用来确定v8.go是否稳定和高效。</p>

<p>项目根目录下有一个叫'text.sh'的shell脚本。这个脚本可以自动配置CGO的环境变量并运行v8.go的测试。</p>

<p>举个例子:</p>

<pre><code>./test.sh . .
</code></pre>

<p>以下命令将执行所以单元测试和基准测试。</p>

<p>test.sh的第一个参数是单元测试的名称匹配模式，第二个参数是基准测试的名称匹配模式。</p>

<p>再举个例子:</p>

<pre><code>./test.sh ThreadSafe Array
</code></pre>

<p>以上命令将运行所有线程安全相关的单元测试和所有Array相关的基准测试。</p>

<h1>
<a name="%E6%A6%82%E5%BF%B5" class="anchor" href="#%E6%A6%82%E5%BF%B5"><span class="octicon octicon-link"></span></a>概念</h1>

<h2>
<a name="engine-1" class="anchor" href="#engine-1"><span class="octicon octicon-link"></span></a>Engine</h2>

<p>在v8.go中，Engine类型是对象v8::Isolate的封装。</p>

<p>因为V8引擎使用线程相关的存储机制用来优化性能，但是CGO调用可能会在不同的线程里执行。所以v8.go使用v8::Locker来确定V8引擎的线程数据有初始化，并确保v8.go是线程安全的。</p>

<p>你可以创建多个引擎实例用来隔离数据和优化并发效率。</p>

<div class="highlight highlight-go"><pre><span class="nx">engine1</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>
<span class="nx">engine2</span> <span class="o">:=</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">NewEngine</span><span class="p">()</span>
</pre></div>

<h2>
<a name="script-1" class="anchor" href="#script-1"><span class="octicon octicon-link"></span></a>Script</h2>

<p>当你要运行一段JavaScript代码前，你需要先把它编译成Script对象。</p>

<p>一个Script对象可以在不同的Context中运行多次。</p>

<div class="highlight highlight-go"><pre><span class="nx">script</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`"Hello " + "World!"`</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</pre></div>

<p>Engine.Compile()方法需要三个参数。</p>

<p>第一个参数是所要编译的JavaScript代码。</p>

<p>第二个参数是一个ScriptOrigin对象，其中存储着脚本对应的文件名和行号等。你可以用ScriptOrigin来让错误信息和栈跟踪信息更友好。</p>

<div class="highlight highlight-go"><pre><span class="nx">name</span> <span class="o">:=</span> <span class="s">"my_file.js"</span>
<span class="nx">real</span> <span class="o">:=</span> <span class="nx">ReadFile</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
<span class="nx">code</span> <span class="o">:=</span> <span class="s">"function(_export){\n"</span> <span class="o">+</span> <span class="nx">real</span> <span class="o">+</span> <span class="s">"\n}"</span>
<span class="nx">origin</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewScriptOrigin</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">script</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</pre></div>

<p>第三个参数是一个ScriptData对象，它是Engine.PreCompile()方法预解析脚本后得到的数据。如果有一段代码你需要反复编译多次，那么你可以先预解析后，用ScriptData来加速编译。</p>

<div class="highlight highlight-go"><pre><span class="nx">code</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`"Hello " + "World!"`</span><span class="p">)</span>
<span class="nx">data</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">PreCompile</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="nx">script1</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
<span class="nx">script2</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</pre></div>

<h2>
<a name="context-1" class="anchor" href="#context-1"><span class="octicon octicon-link"></span></a>Context</h2>

<p>V8嵌入指南中的解释:</p>

<blockquote>
<p>In V8, a context is an execution environment that allows separate, unrelated, JavaScript applications to run in a single instance of V8. You must explicitly specify the context in which you want any JavaScript code to be run.</p>
</blockquote>

<p>在v8.go中，你可以从一个Engine实例中创建多个上下文。当你需要在某个上下文中运行一段JavaScript时，你需要调用Context.Scope()方法进入这个上下文，然后在回调函数中运行JavaScript。</p>

<div class="highlight highlight-go"><pre><span class="nx">context</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">){</span>
    <span class="nx">cs</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>

<p>上下文在V8中是可以嵌套的。所以v8.go中你可以这样做：</p>

<div class="highlight highlight-go"><pre><span class="nx">context</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context2</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">NewContext</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
    <span class="nx">context2</span><span class="p">.</span><span class="nx">Scope</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">cs2</span> <span class="nx">v8</span><span class="p">.</span><span class="nx">ContextScope</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">})</span>
<span class="p">})</span>
</pre></div>

<h2>
<a name="%E6%9B%B4%E5%A4%9A" class="anchor" href="#%E6%9B%B4%E5%A4%9A"><span class="octicon octicon-link"></span></a>更多</h2>

<p>请阅读<code>v8_all_test.go</code>以及<code>samples</code>目录下的示例代码。</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/idada">idada</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-46130857-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>